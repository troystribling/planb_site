<p>
  <a href="http://rspec.rubyforge.org/index.html" target="blank">RSpec</a> is a Ruby 
  <a href="http://en.wikipedia.org/wiki/Behavior_driven_development" target="blank">
  Behavior Driven Development</a> DSL that has received a lot of   
  attention. 
  This article will present a method of extending its functionality 
  that includes adding 
  custom <a    
  href="http://rspec.rubyforge.org/rdoc/classes/Spec/Matchers.html" target="blank">
  matchers</a>, 
  adding methods that are within scope of all <code>describe</code>
  blocks in a project and extending the RSpec
  configuration class to make custom configuration data available to 
  all specs in a project. 
</p>
<p>
  Both 
  <a href="http://www.ibrasten.com/articles/2007/6/1/effectively-communicating-your-expectations" target="blank">Brasten 
  Sager</a> and 
  <a href="http://opensoul.org/2007/4/18/rspec-model-should-be_valid" target="blank">Brandon 
  Keepers</a> describe how to add 
  custom matchers by extending <code>Spec::Rails::Matchers</code> but 
  this method will only be 
  applicable when the the RSpec Rails plugin is installed. The method   
  discussed here will not have this dependency. 
</p>
<p>
  The basis of the approach used in this article to extend RSpec
  is an extension of the method described by   
  <a href="http://blog.nicksieger.com/articles/2007/01/02/customizing-rspec" target="blank">Nick 
  Sieger</a> for an older version of RSpec. 
  For newer versions the names of the modules and classes have   
  changed but the strategy is the same.
</p> 
<p>
  All of the code examples presented here are from the  
  <a href="http://research.inplanb.com/has_ancestor">has_ancestor</a>   
  Ruby on Rails plugin. 
</p>

<h3><code>before_eval</code> in 
<code>Spec::DSL::Behavior</code></h3>
<p>
  In the <code>initialize</code> method of 
  <code>Spec::DSL::Behavior</code> a method, <code>before_eval</code>,
  is provided to do something before the evaluation of specs.   
  The code providing this functionality in 
  <code>lib/spec/dsl/behavior.rb</code> 
  from the RSpec plugin is shown.
</p>
<p> 
 <typo:code lang="ruby">

  module Spec
    module DSL
      class Behaviour
        def initialize(*args, &behaviour_block)
          init_description(*args)
          init_eval_module
          before_eval
          eval_behaviour(&behaviour_block)
        end

      protected
    
        def before_eval
        end

      end
    end
  end


</typo:code>
</p>
<p>
  An implementation of <code>before_eval</code> can   
  <code>include</code> modules that add methods to 
  the <code>describe</code> block scope. 
  The following section will provide an example that implements   
  <code>before_eval</code> to include matchers and other method types.
</p>
<h3>Project Configuration</h3>
<p>
  After either installing the 
  <a href="http://rspec.rubyforge.org/download.html" target="blank">Rspec  
  <code>gem</code> or plugin</a>
  bootstrap RSpec.
</p>
<p>
<typo:code>

  ruby script/generate rspec


</typo:code>
</p>
<p>
  A <code>spec</code> directory will be created in your project 
  directory and in this director <code>spec_helper.rb</code> 
  will be also created. 
</p>
<p>
  In the <code>spec</code> directory create two more directories,
  <code>matchers</code> and <code>extensions</code>, to place custom
  matchers and extensions. In <code>spec</code> 
  create the two files, <code>spec_custom_matchers.rb</code> 
  <code>spec_extensions.rb</code>, to load custom matchers and 
  extensions. The implementation of these files used by the 
  <a href="http://research.inplanb.com/has_ancestor">has_ancestor</a>
  plugin is shown below. 
</p>
<p>
<typo:code lang="ruby">

  dir = File.dirname(__FILE__)

  require File.expand_path("#{dir}/matchers/eql_attributes")
  require File.expand_path("#{dir}/matchers/eql_attribute_value")
  require File.expand_path("#{dir}/matchers/be_implemented")


</typo:code>
</p>
<p>
<typo:code lang="ruby">

  dir = File.dirname(__FILE__)

  require File.expand_path("#{dir}/extensions/model_data")


</typo:code>
</p>
<p>
  <a href="http://research.inplanb.com/has_ancestor">has_ancestor</a> 
  defines custom matchers in the module
  <code>PlanB::SpecMatchers</code> and extensions in the 
  module <code>PlanB::SpecExtensions</code>. The following code is 
  added to <code>spec_helper.rb</code> to load all custom matchers and 
  extensions and to provide an implementation of 
  <code>before_eval</code>, which will
  <code>include</code> the matchers and extensions in 
  the scope of 
  <code>describe</code> blocks.
</p>
<p>
<typo:code lang="ruby">

  require File.dirname(__FILE__) + '/spec_custom_matchers'
  require File.dirname(__FILE__) + '/spec_extensions'

  class Spec::DSL::Behaviour
    def before_eval
      @eval_module.include PlanB::SpecMatchers
      @eval_module.include PlanB::SpecExtensions
    end
  end


</typo:code>
</p>
<h3>Custom Matchers</h3>
<p>
  Rspec <a    
href="http://rspec.rubyforge.org/rdoc/classes/Spec/Matchers.html" target="blank">
  matchers</a> specify the expectations of a spec. They play the 
  role
  of <code>assert</code> in <code>Test::Unit</code>. Rspec provides
  matchers that allow you to write specs like,
</p>
<p>
<typo:code lang="ruby">

  it "should find model by specification of model primary key" do
    ParentModel.find(@p.id).should eql(@p)
  end


</typo:code>
</p>
<p>
 here <code>eql</code> is a matcher provided by RSpec that tests
 for equality between its argument and the left-hand-side of 
 <code>should</code>. 
</p>
<p>
  An example of a
  custom matcher from the 
  <a href="http://research.inplanb.com/has_ancestor">has_ancestor</a>  
  plugin is shown. This matcher tests a list of models for 
  equality between a specified attribute and a specified value.
</p>
<p> 
  All custom 
  matchers must implement <code>matches?</code>,
  <code>failure_message</code> and <code>description</code>. Also,
  an implementation of the matcher method called in specs must 
  be provided that creates the matcher object. 
  In this example
  the matcher method is <code>eql_attribute_value</code>. In a 
  following section an example using this matcher will be provided.
</p>
<p>
<typo:code lang="ruby">

  module PlanB
    module SpecMatchers    

      class EqlAttributeValue  #:nodoc:
    
        def initialize(*exp)
          @mod_attr = exp[0]
          @attr_val = exp[1]
        end
    
        def matches?(mods)
          @mods = mods
          result = @mods.find do |m|
            @attr_val != m.send(@mod_attr)
          end
          result.nil? && mods.size > 1 ? true : false
        end
        
        def failure_message
          error_msg = "Model attribute value error\n"
          error_msg = "Number of models is '#{@mods.size}' expecting more than 1\n"
          @mods.each do |m|
             mod_val = m.send(@mod_attr)
             error_msg << "-for model '#{m.class.name}'\n" 
             error_msg << "  attribute value '#{mod_val}' for '#{@mod_attr.to_s}' expecting '#{@attr_val}'\n" 
          end
          error_msg
        end
  
        def description
          "eql attribute values"
        end
  
      end
    
      def eql_attribute_value(*exp)
        EqlAttributeValue.new(*exp)
      end
   
    end
  end


</typo:code>
</p>
  
<h3>An Extension</h3>
<p>
  An extension is a method that does not support the matcher 
  interface, which is added to the scope of all 
  <code>describe</code> blocks in a project. An example for the 
  <a href="http://research.inplanb.com/has_ancestor">has_ancestor</a>  
  plugin will be described. This extension is used to access data
  loaded from a configuration file and to make the data available
  to specs. Below the extension source is 
  shown. An attribute is added to 
  <code>Spec::DSL::Configuration</code> to hold the configuration
  data and a method is added to <code>PlanB::Extensions</code> to 
  simplify access by delegating to the configuration object.
</p>
<p>
<typo:code lang="ruby">

  class Spec::DSL::Configuration
    attr_accessor :model_data  
  end

  module PlanB
    module SpecExtensions
      def model_data
        Spec::Runner.configuration.model_data
      end  
    end
  end


</typo:code>
</p>
<p>
  Below the modifications made to the default implementaion of 
  <code>Spec::Runner.configure</code> in <code>spec_helper.rb</code>
  to load the configuration data are shown. 
</p>
<p>
<typo:code lang="ruby">

  Spec::Runner.configure do |config|
    config.use_transactional_fixtures = true
    config.use_instantiated_fixtures  = false
    config.fixture_path = File.dirname(__FILE__) + "/../fixtures/"
    config.model_data = File.open(File.dirname(__FILE__) +  '/../fixtures/test_model.yml') {|yf| YAML::load(yf)}
  end


</typo:code>
</p>
<h3>Using The Custom Matcher and Extension</h3>
<p>
  A example illustrating the use of the custom matcher and extension 
  implemented in previous sections is shown. See 
  <a href="http://research.inplanb.com/has_ancestor">has_ancestor</a>
  for more examples.
</p>
<p>
<typo:code lang="ruby">
 
 GrandchildModel.find_all_by_child_model_attr(model_data['GRANDCHILD_MODEL']['child_model_attr']).should 
      eql_attribute_value(:child_model_attr, model_data['GRANDCHILD_MODEL']['child_model_attr']) 


</typo:code>


</p>

